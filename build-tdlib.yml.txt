name: Build TDLib

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-linux:
    name: Linux ${{ matrix.arch }}
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            pkg_arch: x86_64
            use_docker: false
          - arch: aarch64
            pkg_arch: aarch64
            use_docker: true
            docker_img: "arm64v8/ubuntu:22.04"

    steps:
      - name: Checkout TDLib
        uses: actions/checkout@v4
        with:
          repository: tdlib/td
          fetch-depth: 1
          path: td

      - name: Setup QEMU
        if: matrix.use_docker
        run: |
          docker run --rm --privileged tonistiigi/binfmt --install all

      - name: Build (Native)
        if: matrix.use_docker == false
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake gperf jq zlib1g-dev libssl-dev
          
          cmake -S td -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build --target tdjson -j$(nproc)

      - name: Build (Docker ARM64)
        if: matrix.use_docker
        run: |
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/work \
            -w /work \
            ${{ matrix.docker_img }} \
            /bin/bash -c "
              apt-get update && \
              apt-get install -y cmake gperf zlib1g-dev libssl-dev build-essential && \
              cmake -S td -B build -DCMAKE_BUILD_TYPE=Release && \
              cmake --build build --target tdjson -j\$(nproc)
            "

      - name: Collect tdjson
        run: |
          mkdir -p out
          find build -type f -name "libtdjson.so*" -exec cp -P {} out/ \;

      - name: Package
        run: |
          cd out
          tar -czf ../TDLib-tdjson-linux-${{ matrix.pkg_arch }}.tar.gz *

      - name: Get latest gotdbot release tag
        id: rel
        run: |
          TAG=$(curl -s \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/releases/latest \
            | jq -r .tag_name)

          if [ -z "$TAG" ] || [ "$TAG" = "null" ]; then
            echo "No release found in this repository"
            exit 1
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Upload asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.rel.outputs.tag }}
          files: TDLib-tdjson-linux-${{ matrix.pkg_arch }}.tar.gz

  build-macos:
    name: macOS ${{ matrix.arch }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            os: macos-15
          - arch: arm64
            os: macos-14

    steps:
      - name: Checkout TDLib
        uses: actions/checkout@v4
        with:
          repository: tdlib/td
          fetch-depth: 1
          path: td

      - name: Install dependencies
        run: |
          brew install gperf
          brew list cmake &>/dev/null || brew install cmake
          brew list openssl@3 &>/dev/null || brew install openssl
          brew list jq &>/dev/null || brew install jq

      - name: Configure
        run: |
          cmake -S td -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DOPENSSL_ROOT_DIR=$(brew --prefix openssl)

      - name: Build tdjson
        run: |
          cmake --build build --target tdjson -j$(sysctl -n hw.logicalcpu)

      - name: Collect tdjson
        run: |
          mkdir -p out
          find build -type f -name "libtdjson.dylib" -exec cp {} out/ \;
          # Also check for versioned dylibs if they exist
          find build -type f -name "libtdjson.*.dylib" -exec cp {} out/ \; || true

      - name: Package
        run: |
          cd out
          tar -czf ../TDLib-tdjson-macos-${{ matrix.arch }}.tar.gz *

      - name: Get latest gotdbot release tag
        id: rel
        run: |
          TAG=$(curl -s \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/releases/latest \
            | jq -r .tag_name)

          if [ -z "$TAG" ] || [ "$TAG" = "null" ]; then
            echo "No release found in this repository"
            exit 1
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Upload asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.rel.outputs.tag }}
          files: TDLib-tdjson-macos-${{ matrix.arch }}.tar.gz

  build-windows:
    name: Windows ${{ matrix.arch }}
    runs-on: windows-2019
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86
            triplet: x86-windows
            cmake_arch: Win32
          - arch: x64
            triplet: x64-windows
            cmake_arch: x64

    steps:
      - name: Checkout TDLib
        uses: actions/checkout@v4
        with:
          repository: tdlib/td
          fetch-depth: 1
          path: td

      - name: Setup vcpkg
        shell: powershell
        run: |
          if (!(Test-Path vcpkg)) {
             git clone https://github.com/Microsoft/vcpkg.git
             cd vcpkg
             git checkout bc3512a509f9d29b37346a7e7e929f9a26e66c7e
             .\bootstrap-vcpkg.bat
          }

      - name: Install dependencies (vcpkg)
        shell: powershell
        run: |
          cd vcpkg
          .\vcpkg.exe install gperf:${{ matrix.triplet }} openssl:${{ matrix.triplet }} zlib:${{ matrix.triplet }}

      - name: Configure CMake
        shell: powershell
        run: |
          if (Test-Path build) { Remove-Item build -Force -Recurse -ErrorAction SilentlyContinue }
          mkdir build
          cd build
          cmake -A ${{ matrix.cmake_arch }} -DCMAKE_INSTALL_PREFIX:PATH=../td/tdlib -DCMAKE_TOOLCHAIN_FILE:FILEPATH=../vcpkg/scripts/buildsystems/vcpkg.cmake ../td

      - name: Build and Install
        shell: powershell
        run: |
          cd build
          cmake --build . --target install --config Release

      - name: Package
        shell: powershell
        run: |
          mkdir out
          if (Test-Path "td/tdlib/bin") {
             Copy-Item "td/tdlib/bin/*.dll" -Destination "out"
          }
          cd out
          Compress-Archive -Path * -DestinationPath ../TDLib-tdjson-windows-${{ matrix.arch }}.zip

      - name: Get latest gotdbot release tag
        id: rel
        shell: bash
        run: |
          TAG=$(curl -s \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/releases/latest \
            | jq -r .tag_name)

          if [ -z "$TAG" ] || [ "$TAG" = "null" ]; then
            echo "No release found in this repository"
            exit 1
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Upload asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.rel.outputs.tag }}
          files: TDLib-tdjson-windows-${{ matrix.arch }}.zip
